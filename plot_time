#!/bin/bash
#
# Plot tab separated values time series data


usage() {
	cat <<EOF
Usage: `basename $0` [--help] [--pdf FILENAME] [FILE] [FIELD...]
EOF
}

PLOT=true
OUT=screen
while [ -n "$1" ]; do
	case "$1" in
		--show)
			SHOW=true ;;
		--noplot)
			unset PLOT ;;
		--log|--logscale)
			SET_LOGSCALE="set logscale y" ;;
		--pdf)
			OUT=pdf
			OUTFILENAME=$2
			shift ;;
		--ps)
			OUT=postscript
			OUTFILENAME=$2
			shift ;;
		--help)
			usage
			exit 0 ;;
		-)
			# FIXME this munges quoting
			ARGS="$ARGS $1" ;;
		-*)
			echo Unknown option $1
			usage
			exit 1 ;;
		*)
			# FIXME this munges quoting
			ARGS="$ARGS $1" ;;
	esac
	shift
done
set -- $ARGS

if [ -z "$1" ]; then
	echo need filename
	exit 1
fi
FILE="$1"
shift

TEMPFILE=`tempfile`

(
	#echo $"set label 'generated by `whoami` at `date +%Y-%m-%d`' at 1,1"
	cat <<EOF
		set timestamp 'generated by `whoami` at %Y-%m-%d %H:%M:%S'
		set title 'Time series Plot'
		set xlabel 'Time'
		set ylabel 'units'

		set style data lines
		set timefmt '%s'
		set xdata time
		set format x "%Y-%m-%d %H:%M"
		set xtics out rotate by -35
		set mouse clipboardformat 5
		set mouse mouseformat 5
		set grid

		$SET_LOGSCALE
EOF

	if [ "$OUT" = "pdf" ]; then
		echo $"set terminal pdf size 11,8"
		echo $"set output '$OUTFILENAME'"
	elif [ "$OUT" = "postscript" ]; then
		echo $"set terminal postscript color solid"
		echo $"set output '$OUTFILENAME'"
	fi
	echo

	LINE=""
	for f in $*; do
		if [ -e $f ]; then
			# This arg is a filename
			FILE=$f
			continue
		fi

		# This arg is a column

		# try to guess the column name
		FIELD=`head -500 $FILE | egrep "^#column $f " | cut -d" " -f3-`:

		TITLE="$FIELD$FILE:$f"

		if [ -n "$LINE" ]; then
			LINE="$LINE,"
		fi
		LINE="$LINE '$FILE' using 1:$f title '$TITLE'"
	done

	if [ -z "$LINE" ]; then
		# default to column 2, if none are on the cmdline
		LINE="'$FILE' using 1:2 title '$FILE:2'"
		
	fi

	echo "plot $LINE"
	echo

	if [ "$OUT" = "screen" ]; then
		echo $"pause mouse close"
	fi

) >$TEMPFILE

if [ -n "$SHOW" ]; then
	cat $TEMPFILE
fi

if [ -n "$PLOT" ]; then
	gnuplot $TEMPFILE
fi

rm -f $TEMPFILE

